<!DOCTYPE html>
<html>
<head>
  <title>Registro de Ubicación</title>
  <script>
    // Configuración inicial
    const ZONA = 'centro1'; // Ajusta el nombre de la zona aquí

    function registrarDatos() {
      navigator.geolocation.getCurrentPosition(function(position) {
        const latitud = position.coords.latitude;
        const longitud = position.coords.longitude;
        const fechaHora = new Date().toLocaleString();
        const datos = {
          fechaHora: fechaHora,
          latitud: latitud,
          longitud: longitud,
          zona: ZONA
        };

        // Guarda los datos en localStorage
        let registros = localStorage.getItem('registros');
        if (!registros) {
          registros = [];
        } else {
          registros = JSON.parse(registros);
        }
        registros.push(datos);
        localStorage.setItem('registros', JSON.stringify(registros));

        alert('Datos registrados correctamente.');
        enviarDatos(); // Intentar enviar los datos inmediatamente
      });
    }

    function enviarDatos() {
      if (navigator.onLine) {
        let registros = localStorage.getItem('registros');
        if (registros) {
          registros = JSON.parse(registros);
          registros.forEach((registro) => {
            const formData = new FormData();
            formData.append('fechaHora', registro.fechaHora);
            formData.append('latitud', registro.latitud);
            formData.append('longitud', registro.longitud);
            formData.append('zona', registro.zona);

            fetch('https://script.google.com/macros/s/AKfycbzuk53CV8U8GHfwuBX3uh0RpkjSQutnxt1eTHGUMeXRZrqg9f-NIs62Hij9UyOnfr2t/exec', {
              method: 'POST',
              body: formData
            })
              .then(response => response.text())
              .then(result => console.log('Datos enviados:', result))
              .catch(error => console.error('Error enviando los datos:', error));
          });
          localStorage.removeItem('registros'); // Limpiar registros después de enviarlos
        }
      } else {
        console.log('No hay conexión a internet.');
      }
    }

    window.onload = function() {
      document.getElementById('registrar').onclick = registrarDatos;
      enviarDatos(); // Intentar enviar los datos cuando se carga la página
    };
  </script>
</head>
<body>
  <h1>Registro de Ubicación</h1>
  <button id="registrar">Registrar Ubicación</button>
</body>
</html>

